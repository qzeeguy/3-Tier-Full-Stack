name: CI Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Install Vault CLI
      - name: Install Vault CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg software-properties-common curl
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vault jq

      # Authenticate with Vault using single AppRole
      - name: Authenticate with Vault
        env:
          VAULT_ADDR: http://52.204.202.23:8200
          ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          VAULT_TOKEN=$(vault write -field=token auth/approle/login role_id=$ROLE_ID secret_id=$SECRET_ID)
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      # Fetch all secrets from Vault paths
      - name: Fetch Secrets
        run: |
          GITHUB_USER=$(VAULT_TOKEN=$VAULT_TOKEN vault kv get -field=username secret/github)
          GITHUB_TOKEN=$(VAULT_TOKEN=$VAULT_TOKEN vault kv get -field=token secret/github)
          DOCKER_USER=$(VAULT_TOKEN=$VAULT_TOKEN vault kv get -field=username secret/dockerhub)
          DOCKER_PASS=$(VAULT_TOKEN=$VAULT_TOKEN vault kv get -field=password secret/dockerhub)
          SONARQUBE_TOKEN=$(VAULT_TOKEN=$VAULT_TOKEN vault kv get -field=token secret/sonarqube)

          echo "GITHUB_USER=$GITHUB_USER" >> $GITHUB_ENV
          echo "GITHUB_TOKEN=$GITHUB_TOKEN" >> $GITHUB_ENV
          echo "DOCKER_USER=$DOCKER_USER" >> $GITHUB_ENV
          echo "DOCKER_PASS=$DOCKER_PASS" >> $GITHUB_ENV
          echo "SONARQUBE_TOKEN=$SONARQUBE_TOKEN" >> $GITHUB_ENV

      # Build & Test
      - name: Build & Test
        run: |
          npm ci
          npm test

      # SonarQube Analysis
      - name: SonarQube Analysis
        run: |
          SONARQUBE_URL="http://100.53.185.191:9000"
          npx sonar-scanner \
            -Dsonar.projectKey=node-app \
            -Dsonar.sources=. \
            -Dsonar.host.url=$SONARQUBE_URL \
            -Dsonar.login=$SONARQUBE_TOKEN

      # Docker Build & Push
      - name: Docker Build & Push
        run: |
          echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_NAME="myrepo/myimage"
          IMAGE_TAG="${TIMESTAMP}-build${GITHUB_RUN_NUMBER}"
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
